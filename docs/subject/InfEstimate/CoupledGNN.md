# CoupledGNN

## 0 论文信息

**Author**：Qi Cao, Huawei Shen, Jinhua Gao, Bingzheng Wei, Xueqi Cheng

**Conference**：WSDM‘ 20

## 1 模型输入

```
adj
邻接矩阵的稀疏表示，不带边权重

  (0, 1)	1
  (0, 2)	1
  (0, 3)	1
  (0, 4)	1
  (0, 5)	1
  (0, 6)	1
  (0, 7)	1

```



```
x
[[(0.0, 128), (1.0, 8), (1.0, 272), (1.0, 275), (1.0, 276), (1.0, 278)],
 [(0.0, 416), (1.0, 100), (1.0, 347), (1.0, 574), (1.0, 575)], 
 ...
 [(0.0, 376), (1.0, 38), (1.0, 236), (1.0, 413), (1.0, 603), (1.0, 604)]]
 
 (t, v) -> t 表示在时间戳 t 节点 v 被激活
 t=0.0 即为种子节点
 其实把 t=0.0/1.0 的节点都视为种子节点即可
```

```
y
[{128, 8, 272, 275, 276, 278, 10, 1038, 15, 14, 279, 263, 485},
 {416, 100, 347, 574, 575, 586, 587, 588, 589, 459, 83, 499, 863},
 ...
 {376, 38, 236, 413, 603, 604, 701, 1065, 123, 925, 754, 571, 569}]
 
 {}内为对应输入的种子节点传播后，被激活的节点
```

```
inputs_features
其实就是提前训练好的 embedding

0 -1.3192978 -1.6224978 0.083175085 2.0910017 0.69537944 -1.6668121 1.0192779 1.2904398
1 0.3020376 3.4533591 2.8349102 -1.7246364 1.4201362 -2.003864 4.218887 1.8642923
2 1.6575426 -1.0241964 2.5960062 0.7196445 -0.5991344 -1.6402906 -0.5069553 4.557169
...
```



## 2 State Graph Neural Network

每个用户都与一个一维值 $s_v$ 相关联，表示用户 $v$ 的激活状态。

此外，由于每对用户之间的人际影响力通常是多样的，我们通过影响力门控机制对这种异质影响权重进行建模，即，(相当于每对用户之间的边权重)

**影响门控  $InfluGate$**

$InfluGate(r_u^{(k)}, r_v^{(k)}) = \beta^{(k)} [W^{(k)} r_u^{(k)} ∥W^{(k)} r_v^{(k)} ]$

其中，$r_u^{(k)} \in R^{h^{(k)}}$ 是用户 $u$ 在第 $k$ 层的**影响力表征**，$W^{(k)} \in R^{h^{(k+1)} \times h^{(k)}}$ 是一个权重矩阵用于将影响力表征从 $h(k)$ 维度转变为 $h(k+1)$ 维度，$\beta(k) \in R^{2h^{(k+1)}}$ 是一个权重向量。上述的 $InfluGate(*)$ 只是其中一种实现形式，我们还可以选择其他类型的函数来反映这对用户之间的影响门控。

通过影响门控函数得到异质影响权重后，目标用户 $v$ 从其邻域接收到的期望影响的聚合为：

$AGGREGATE(*) = a_v^{(k)} = \sum_{u \in N(v)} InfluGate(r_u^{(k)}, r_v^{(k)})s_u^{(k)} + p_v$

$p_v \in R$ 是一个自激活参数，用于反映用户 $v$ 可能通过脱离跟随关系的方式被激活的概率，例如离线交流或浏览首页的热门列表。

那么用于更新用户 $v$ 激活状态的 $COMBINE(*)$ 函数定义为邻域聚合与用户 $v$ 自身激活状态的加权和：
$$
COMBINE(*) = s_v^{(k+1)}=\begin{cases}
1, \quad  \quad  \quad  \quad  \quad  \quad  \quad  \quad  \ \ \  v \in C^m_T \\
\sigma(\mu_s^{(k)}s_v^{(k)} + \mu_a^{(k)}a_v^{(k)}) \quad  v \notin C^m_T \\ 
\end{cases}
$$
节点的初始激活状态为：
$$
s_v^{(0)}=\begin{cases}
1, \ \  v \in C^m_T \\
0, \ \  v \notin C^m_T \\ 
\end{cases}
$$

## 3 Influence Graph Neural Network

影响图神经网络是**对社交网络中人际影响的扩散进行建模**。 具体来说，每个用户 $v$ 都与一个影响表示 $r_v$ 相关联。然后活跃用户的影响表示随着网络结构进一步扩散到其他用户，通过图神经网络的邻域聚合和状态门控机制实现。影响图神经网络的整个机制如图所示。具体而言，邻域聚合定义为:

$AGGREGATE(*) = b_v^{(k)} = \sum_{u \in N(v)}StateGate(s_u^{(k)}) \alpha_{uv}^{(k)} W^{(k)} r^{(k)}_u$

其中，$\alpha_{uv}^{(k)}$ 是 attention 权重，$StateGate(∗)$ 是状态门控机制，在本文中由 3 层 MLP 实现，以反映状态的非线性效应。

$e_{uv}^{(k)} = \gamma^{(k)} [W^{(k)} r_u^{(k)} ∥W^{(k)} r_v^{(k)} ]$

$\alpha^{(k)}_{uv} = softmax(e^{(k)}_{uv}) = \frac{exp(e^{(k)}_{uv})}{\sum_{z\in N(v)}exp(e^{(k)}_{zv})}$

$COMBINE(*) = r^{(k+1)} =σ(􏰀\zeta_r^{(k)}W^{(k)}r^{(k)}_v +\zeta_b^{(k)}b_v^{(k)}􏰁)$

**节点的初始影响表征值由两部分组成，节点嵌入值和节点标签。**



## 4 模型输出

经过 K 层图神经网络的**激活状态**（State GNN）和**影响表示**（Influence GNN）后，网络中每个用户的输出激活概率为 $s(K) \in [0,1]$，即状态图中最后 $v$ 层的输出神经网络。然后通过网络中所有用户的总和池机制获得要预测的流行度，即

$\widehat{n}^{m}_{\infin} = 􏰉\sum_{u \in V} s^{(K)}_u$

MRSE 损失函数为，$n^m_∞$ 是真是的最后的信息 $m$ 的流行度：

$L_{MRSE}=\frac{1}{M} \sum_{m=1}^{M} (\frac{\widehat{n}^m_\infin - n^m_\infin}{n^m_\infin})^2$

正则化项，其中 $P$ 是参数集合，$\eta$ 和 $\lambda$ 都是超参数，$L_{user}$ 用户层面的交叉熵，$s_V^\infin$ 是每个用户真实的最后的激活状态值：

$L_{Reg}=\eta \sum_{􏰈p \in P} ∥p∥_2 + \lambda L_{user}$， $L_{user} = \frac{1}{􏰈M} \sum_{m=1}^M􏰈 \frac{1}{|V|}􏰀 \sum_{v \in V} (s_v^\infin log\ s^{(K)}_v+(1−s_v^\infin )logs^{(K)}_v􏰁)$

为防止过拟合，对目标损失函数添加 L2 正则化和用户层面的交叉熵：

$L = L_{MRSE} + L_{Reg}$ 











